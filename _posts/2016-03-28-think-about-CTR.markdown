---
layout: post
title:  "简单聊聊CTR（一）"
date:   2016-03-17 15:30:00 +0800
categories: 业务分析
---

最近在和一些实习生一起讨论工作的时候，大家经常碰到的一个问题就是CTR如何更加合理的计算，其间也有很多争论，当然也有很多研究去讨论解决方案。这里主要记录下自己在工作中一些经验和踩过的坑。

## CTR是什么？

CTR，可以指的是uv点击率，也可以是pv点击率等。可以用于考核整个页面，也可以考核一个区块，更可以考虑一个区块里的内容。不论业务是如何的，本质上CTR就是a/b的形式，用来解释用户对于内容是否满意的指标。CTR的值可以从0到positive infinite，而不是0到1。这个很好理解，比如我们搜索后，在页面点击多次，从页面的pv点击率上看 就是大于1的。

在实际工作中，我们优化的目标往往是CTR。比如商品搜索，我们总是把CTR高的商品排在前面（naive的商品搜索，不考虑其他逻辑）。可以简单的认为搜索或者推荐核心问题都是在估计商品，文章，page的点击概率。由于我工作的场景主要是商品，下面我们都建设优化的目标都是商品。

## 冷门商品的CTR如何计算？

在优化CTR之前，让我们看看第一个问题：我们能不能通过日志来计算出商品的CTR？（在实际工作中，我们往往会和实习生一起去计算一些核心指标去加深业务理解，顺便还能加强算法思考，所以这个问题是真实有效的）

最直接的答案当然是可以计算的。针对任何一个商品，我们通过日志可以收集到pv和click。

	ctr = click/pv 

这样统计的同学往往遇到的第一个问题（当然除了清洗数据之外。。。）就是发现有对于pv很小的商品，CTR往往都不准确，比如非热门商品，新上商品等。其背后的含义是这样的商品直接用click除以pv得到的CTR是不具有统计意义的；另外由于pv很少（可以理解为观测值很少）其得到的指标的variance会很大，不置信。

为了解决这样的问题，一个很直接的做法是给每个商品加一个默认pv数：C。

	ctr＝click/(pv+C)

加入C的基本想法是去除小样本带来的数据不置信的问题，C选多少我们先放一边，只是这么做对于较小pv商品相当于做了CTR截断，随着C的变大，越来越多的商品被这种统计方式丢弃。

再加个补丁吧，给click也加个默认点击数：V。

	ctr = (click + V)/(pv+C)

这种形态的优化，多了另外一个参数V，这种做法叫做：贝叶斯平均。合适的V，C选择能否使得曝光比较少的商品统计的到的CTR与曝光很多的商品接近，能够修正CTR计算中的马太效应（强者恒强）。

另外一种在实际工作中常用的计算方法是wilson置信区间下界，而且可以把置信度取得高一点，能够比较好的解决小样本置信度的问题。


![](http://chart.googleapis.com/chart?cht=tx&chl=%5Cfrac%7B%5Chat%7Bp%7D%2B%5Cfrac%7B1%7D%7B2n%7Dz%5E%7B2%7D_%7B1-%5Cfrac%7B%5Calpha%7D%7B2%7D%7D%5Cpm%20z_%7B1-%5Cfrac%7B%5Calpha%7D%7B2%7D%7D%5Csqrt%7B%5Cfrac%7B%5Chat%7Bp%7D(1-%5Chat%7Bp%7D)%7D%7Bn%7D%2B%5Cfrac%7Bz%5E%7B2%7D_%7B1-%5Cfrac%7B%5Calpha%7D%7B2%7D%7D%7D%7B4n%5E%7B2%7D%7D%7D%7D%7B1%2B%5Cfrac%7B1%7D%7Bn%7Dz%5E%7B2%7D_%7B1-%5Cfrac%7B%5Calpha%7D%7B2%7D%7D%7D&chs=180)

相应带来的问题就是对于小样本计算出的ctr会很小，这个和上面说的贝叶斯平均有很大的区别。wilson置信区间会随着pv数的增大，收敛到click/pv附近，而且收敛速度并不慢（当pv超过一定数值后，下界会很接近统计值），这里在实际应用的时候最好能否对pv做一定的变形。

下面一篇会介绍热门商品的CTR，和把beta分布解释CTR问题。后期会涉及CTR计算中曝光位置等问题。







